<app-navigation-bar></app-navigation-bar>

<div class="page-content">
  <h2>Create Prescription</h2>

  <form (ngSubmit)="submitConsultation()" #prescriptionForm="ngForm">

    <!-- Symptoms -->
    <div class="mb-3">
      <label class="form-label">Symptoms</label>
      <textarea
        class="form-control"
        [(ngModel)]="prescription.symptoms"
        name="symptoms"
        required>
      </textarea>
    </div>

    <!-- Diagnosis -->
    <div class="mb-3">
      <label class="form-label">Diagnosis</label>
      <textarea
        class="form-control"
        [(ngModel)]="prescription.diagnosis"
        name="diagnosis"
        required>
      </textarea>
    </div>

    <!-- Notes -->
    <div class="mb-3">
      <label class="form-label">Notes</label>
      <textarea
        class="form-control"
        [(ngModel)]="prescription.notes"
        name="notes">
      </textarea>
    </div>

    <!-- Medicines Section -->
    <h4 class="section-heading text-white">Medicines</h4>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Medicine Name</th>
          <th>Dosage</th>
          <th>Duration</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let med of medicines; let i = index">
          <!-- Medicine Name -->
          <td>
            <select
              class="form-select"
              [(ngModel)]="med.medicineId"
              name="medicineId{{i}}"
              required>
              <option value="" disabled>Select Medicine</option>
              <option *ngFor="let m of availableMedicines" [value]="m.medicineId">
                {{ m.medicineName }}
              </option>
            </select>
          </td>

          <!-- Dosage -->
          <td>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="med.dosage"
              name="dosage{{i}}"
              required
              pattern="^(?=.*[0-9])(?=.*[A-Za-z])[A-Za-z0-9\\s]+$"
              #dosageCtrl="ngModel" />
            <div *ngIf="dosageCtrl.invalid && dosageCtrl.touched" class="text-danger small mt-1">
              Must contain both letters and numbers.
            </div>
          </td>

          <!-- Duration -->
          <td>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="med.duration"
              name="duration{{i}}"
              required
              pattern="^(?=.*[0-9])(?=.*[A-Za-z])[A-Za-z0-9\\s]+$"
              #durationCtrl="ngModel" />
            <div *ngIf="durationCtrl.invalid && durationCtrl.touched" class="text-danger small mt-1">
              Must contain both letters and numbers.
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <button type="button" class="btn btn-navy mb-3" (click)="addMedicineRow()">
      + Add Medicine
    </button>

    <!-- Lab Tests Section -->
    <div class="mt-4">
      <h4 class="section-heading text-white">Lab Tests</h4>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th style="width: 50%">Test Name</th>
            <th style="width: 10%">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let lab of labTests; let i = index">
            <td>
              <select
                class="form-select"
                [(ngModel)]="lab.labId"
                name="labId{{ i }}"
                required>
                <option value="" disabled>Select Test</option>
                <option *ngFor="let t of availableLabTests" [ngValue]="t.labId">
                  {{ t.labName }}
                </option>
              </select>
            </td>
            <td class="text-center">
              <button
                type="button"
                class="btn btn-danger btn-sm"
                (click)="removeLabTestRow(i)"
                *ngIf="labTests.length > 1">
                Ã—
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      <button type="button" class="btn btn-navy" (click)="addLabTestRow()">
        + Add Lab Test
      </button>
    </div>

    <!-- Submit -->
    <div class="text-center mt-4">
      <button type="submit" class="btn btn-secondary" [disabled]="prescriptionForm.invalid">
        Submit Consultation
      </button>
      <button type="button" class="btn btn-primary ms-2" (click)="cancel()" >
        Cancel
      </button>
    </div>
  </form>
</div>
