<div class="appointment-container">
  <h2>Appointment Scheduling</h2>

  <!-- Search Patient -->
  <div class="search-section">
    <label for="registerNumber">Register Number:</label>
    <input type="text" id="registerNumber" [(ngModel)]="registerNumber" placeholder="Enter register number"
      (keyup.enter)="searchPatients()" />
    <button (click)="searchPatients()">Search</button>
    <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>
  </div>

  <!-- Patient List -->
  <div *ngIf="searchedPatients.length > 0" class="patient-list">
    <h3>Select Patient</h3>
    <ul>
      <li *ngFor="let patient of searchedPatients" (click)="selectPatient(patient)"
        [class.selected]="selectedPatient?.patientId === patient.patientId">
        {{ patient.firstName }} {{ patient.lastName }} (ID: {{ patient.patientId }})
      </li>
    </ul>
  </div>

  <!-- Appointment Form -->
  <form *ngIf="selectedPatient" (ngSubmit)="scheduleAppointment()" class="appointment-form">
    <h3>Schedule Appointment for {{ selectedPatient.firstName }} {{ selectedPatient.lastName }}</h3>

    <div class="form-group">
      <label for="department">Department:</label>
      <select id="department" [(ngModel)]="selectedDepartmentId" (change)="onDepartmentChange()" name="department"
        required>
        <option [value]="null" disabled selected>Select Department</option>
        <option *ngFor="let dept of departments" [value]="dept.departmentId">
          {{ dept.departmentName }}
        </option>
      </select>
    </div>

    <div class="form-group">
      <label for="doctor">Doctor:</label>
      <select id="doctor" [(ngModel)]="newAppointment.doctorId" name="doctor" required>
        <option [value]="0" disabled selected>Select Doctor</option>
        <option *ngFor="let doc of doctors" [value]="doc.doctorId">
          Dr. {{ doc.doctorName }}
        </option>
      </select>
    </div>

    <div class="form-group">
      <label for="appointmentDate">Date:</label>
      <input type="date" [(ngModel)]="newAppointment.appointmentDate" name="appointmentDate" [min]="todayString" required />
    </div>

    <div class="form-group">
      <label for="appointmentTime">Time:</label>
      <select id="appointmentTime" [(ngModel)]="newAppointment.appointmentTime" name="appointmentTime" required>
        <option value="" disabled selected>Select Time</option>
        <option *ngFor="let time of availableTimes" [value]="time" [disabled]="isTimeSlotBooked(time)">
          {{ time }}
        </option>
      </select>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn-primary">
        {{ isEditMode ? 'Update Appointment' : 'Schedule Appointment' }}
      </button>
      <button type="button" class="btn-secondary" (click)="resetAppointmentForm()">
        Reset
      </button>
    </div>

    <p class="success" *ngIf="successMessage">{{ successMessage }}</p>
    <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>
  </form>

  <!-- Appointment List -->
  <div *ngIf="appointments.length > 0 && selectedPatient" class="appointments-list">
    <h3>Existing Appointments</h3>
    <table>
      <thead>
        <tr>
          <th>Appointment No.</th>
          <th>Date</th>
          <th>Time</th>
          <th>Doctor</th>
          <th>Token</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let appt of appointments">
          <td>{{ appt.appointmentNumber }}</td>
          <td>{{ appt.appointmentDate | date: 'mediumDate' }}</td>
          <td>{{ appt.appointmentTime }}</td>
          <td>Dr. {{ getDoctorNameById(appt.doctorId) }}</td>
          <td>{{ appt.tokenNumber }}</td>
          <td>
            <button (click)="editAppointment(appt)" class="btn-edit">Edit</button>
            <button (click)="deleteAppointment(appt.appointmentId!)" class="btn-delete">
              Delete
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>